(function(a){a.omWidget("om.omCalendar",{options:{date:new Date(),startDay:0,pages:1,minDate:false,maxDate:false,popup:true,showTime:false,onSelect:function(b,c){},disabledDays:[],disabledFn:function(b){},disabled:false,readOnly:false,editable:true,dateFormat:false},disable:function(){if(this.options.popup){this.hide();this.options.disabled=true;this.element.attr("disabled",true).unbind(".omCalendar").next().addClass("om-state-disabled").unbind()}},enable:function(){if(this.options.popup){this.options.disabled=false;this.element.attr("disabled",false).next().removeClass("om-state-disabled");this._buildStatusEvent()}},getDate:function(){return this.options.date},setDate:function(b){this.options.date=b;this._render({date:b})},_create:function(){var c=this.element,b=this.options;this.cid=this._stamp(c);if(b.popup){c.wrap("<span></span>").after('<span class="om-calendar-trigger"></span>').parent().addClass("om-calendar om-widget om-state-default");this.con=a("<div></div>").appendTo(document.body).css({top:"0px",position:"absolute",background:"white",visibility:"hidden","z-index":"2000"});this._buildBodyEvent();this._buildStatusEvent()}else{this.con=this.element}this.con.addClass("om-calendar-list-wrapper om-widget om-clearfix om-widget-content")},_init:function(){var c=this.element,b=this.options;this.con.addClass("multi-"+b.pages);this._buildParam();if(b.popup){c.val()&&(b.date=a.omCalendar.parseDate(c.val(),b.dateFormat||this._defaultFormat)||new Date())}this._render();if(b.readOnly||!b.editable){c.attr("readonly","readOnly").unbind()}else{c.removeAttr("readonly")}b.disabled?this.disable():this.enable()},_render:function(d){var g=0,b,e,h,k=this.element,c=this.options;this.ca=[];this._parseParam(d);this.con.html("");for(g=0,h=[this.year,this.month];g<c.pages;g++){if(g===0){b=true}else{b=false;h=this._computeNextMonth(h)}e=g==(c.pages-1);this.ca.push(new a.om.omCalendar.Page({year:h[0],month:h[1],prevArrow:b,nextArrow:e,showTime:self.showTime},this));this.ca[g]._render()}if(c.pages>1){var f=k.find(".om-cal-box");var j=[];a.each(f,function(l,m){j.push(a(m).css("height"))});j.sort();f.css("height",j[j.length-1])}},_stamp:function(b){if(b.attr("id")===undefined||b.attr("id")===""){b.attr("id","K_"+new Date().getTime())}return b.attr("id")},_buildStatusEvent:function(){var b=this;this.element.unbind(".omCalendar").bind("click.omCalendar",function(c){b.toggle()}).bind("focus.omCalendar",function(){a(this).parent().addClass("om-state-hover om-state-active")}).bind("blur.omCalendar",function(){a(this).parent().removeClass("om-state-hover om-state-active")}).next().unbind().click(function(){b.element.trigger("focus");b.show()}).mouseover(function(){a(this).parent().addClass("om-state-hover")}).mouseout(function(){!b.isVisible()&&a(this).parent().removeClass("om-state-hover")})},_buildBodyEvent:function(){var b=this;a(document).bind("mousedown.omCalendar",this.globalEvent=function(c){b.hide()});b.con.mousedown(function(c){c.stopPropagation()})},toggle:function(){if(!this.isVisible()){this.show()}else{this.hide()}},isVisible:function(){if(this.con.css("visibility")=="hidden"){return false}return true},show:function(){var e=this.element.parent();this.con.css("visibility","");var d=e.offset().left,b=e.offsetHeight||e.outerHeight(),c=e.offset().top+b;this.con.css("left",d.toString()+"px");this.con.css("top",c.toString()+"px")},hide:function(){this.con.css("visibility","hidden")},destroy:function(){var b=this.element;a("body").unbind(".omCalendar",this.globalEvent);if(this.options.popup){b.parent().after(b).remove();this.con.remove()}},_buildParam:function(){var b=this.options;b.startDay&&(b.startDay=(7-b.startDay)%7);!b.dateFormat&&(this._defaultFormat=b.showTime?"yy-mm-dd H:i:s":"yy-mm-dd");this.EV=[];return this},_parseParam:function(b){b&&a.extend(this.options,b);this._handleDate()},_templetShow:function(c,h){var e,j,d,b,g,f;if(h instanceof Array){e="";for(d=0;d<h.length;d++){e+=arguments.callee(c,h[d])}c=e}else{j=c.match(/{\$(.*?)}/g);if(h!==undefined&&j!==null){for(d=0,b=j.length;d<b;d++){f=j[d].replace(/({\$)|}/g,"");g=(h[f]!==undefined)?h[f]:"";c=c.replace(j[d],g)}}}return c},_handleDate:function(){var b=this.options.date;this.day=b.getDate();this.month=b.getMonth();this.year=b.getFullYear()},_getHeadStr:function(b,c){return b.toString()+a.om.lang.omCalendar.year+(Number(c)+1).toString()+a.om.lang.omCalendar.month},_monthAdd:function(){var b=this;if(b.month==11){b.year++;b.month=0}else{b.month++}b.options.date.setFullYear(b.year,b.month,1);return this},_monthMinus:function(){var b=this;if(b.month===0){b.year--;b.month=11}else{b.month--}b.options.date.setFullYear(b.year,b.month,1);return this},_computeNextMonth:function(b){var d=b[0],c=b[1];if(c==11){d++;c=0}else{c++}return[d,c]},_handleOffset:function(){var d=this,g=a.om.lang.omCalendar,f=[g.Su,g.Mo,g.Tu,g.We,g.Th,g.Fr,g.Sa],c="<span>{$day}</span>",j=this.options.startDay,h="",b=[];for(var e=0;e<7;e++){b[e]={day:f[(e-j+7)%7]}}h=d._templetShow(c,b);return{day_html:h}}});a.extend(a.om.omCalendar,{Page:function(c,b){var d=a.om.lang.omCalendar;this.father=b;this.month=Number(c.month);this.year=Number(c.year);this.prevArrow=c.prevArrow;this.nextArrow=c.nextArrow;this.node=null;this.timmer=null;this.id="";this.EV=[];this.html=['<div class="om-cal-box" id="{$id}">','<div class="om-cal-hd om-widget-header">','<a href="javascript:void(0);" class="om-prev {$prev}"><span class="om-icon om-icon-seek-prev">Prev</span></a>','<a href="javascript:void(0);" class="om-title">{$title}</a>','<a href="javascript:void(0);" class="om-next {$next}"><span class="om-icon om-icon-seek-next">Next</span></a>',"</div>",'<div class="om-cal-bd">','<div class="om-whd">',b._handleOffset().day_html,"</div>",'<div class="om-dbd om-clearfix">',"{$ds}","</div>","</div>",'<div class="om-setime om-state-default hidden">',"</div>",'<div class="om-cal-ft {$showtime}">','<div class="om-cal-time om-state-default">',"时间：00:00 &hearts;","</div>","</div>",'<div class="om-selectime om-state-default hidden">',"</div>","</div><!--#om-cal-box-->"].join("");this.nav_html=["<p>",d.month,'<select value="{$the_month}">','<option class="m1" value="1">01</option>','<option class="m2" value="2">02</option>','<option class="m3" value="3">03</option>','<option class="m4" value="4">04</option>','<option class="m5" value="5">05</option>','<option class="m6" value="6">06</option>','<option class="m7" value="7">07</option>','<option class="m8" value="8">08</option>','<option class="m9" value="9">09</option>','<option class="m10" value="10">10</option>','<option class="m11" value="11">11</option>','<option class="m12" value="12">12</option>',"</select>","</p>","<p>",d.year,'<input type="text" value="{$the_year}" onfocus="this.select()"/>',"</p>","<p>",'<button class="ok">',d.ok,'</button><button class="cancel">',d.cancel,"</button>","</p>"].join("");this.Verify=function(){var f=function(h){if(!/^\d+$/i.test(h)){return false}h=Number(h);return !(h<1||h>31)},e=function(h){if(!/^\d+$/i.test(h)){return false}h=Number(h);return !(h<100||h>10000)},g=function(h){if(!/^\d+$/i.test(h)){return false}h=Number(h);return !(h<1||h>12)};return{isDay:f,isYear:e,isMonth:g}};this._renderUI=function(){var h=this,e={},g,f=h.father.options;h.HTML="";e.prev="";e.next="";e.title="";e.ds="";if(!h.prevArrow){e.prev="hidden"}if(!h.nextArrow){e.next="hidden"}if(!h.father.showTime){e.showtime="hidden"}e.id=h.id="om-cal-"+Math.random().toString().replace(/.\./i,"");e.title=h.father._getHeadStr(h.year,h.month);h.createDS();e.ds=h.ds;h.father.con.append(h.father._templetShow(h.html,e));h.node=a("#"+h.id);if(f.showTime){g=h.node.find(".om-cal-ft");g.removeClass("hidden");h.timmer=new a.om.omCalendar.TimeSelector(g,h.father)}return this};this._buildEvent=function(){var g=this,e=a("#"+g.id),f=g.father.options;g.EV[0]=e.find("div.om-dbd").bind("mousedown",function(j){var l=a(j.target);if(l.filter(".om-null, .om-state-disabled").length>0){return}var i=Number(l.html());var k=new Date(f.date);k.setFullYear(g.year,g.month,i);g.father.dt_date=k;if(!f.showTime){g.father._trigger("onSelect",j,k)}if(f.popup&&!f.showTime){g.father.hide();if(!isNaN(g.father.dt_date)){var h=a.omCalendar.formatDate(g.father.dt_date,f.dateFormat||g.father._defaultFormat);a(g.father.element).val(h).focus().blur()}}g.father._render({date:k})}).find("a").bind("mouseover",function(h){a(this).addClass("om-state-hover om-state-nobd")}).bind("mouseout",function(h){a(this).removeClass("om-state-hover").not(".om-state-highlight, .om-state-active").removeClass("om-state-nobd")});g.EV[1]=e.find("a.om-prev").bind("click",function(h){g.father._monthMinus()._render();return false});g.EV[2]=e.find("a.om-next").bind("click",function(h){g.father._monthAdd()._render();return false});g.EV[3]=e.find("a.om-title").bind("click",function(i){try{g.timmer.hidePopup()}catch(j){}var h=g.father._templetShow(g.nav_html,{the_month:g.month+1,the_year:g.year});e.find(".om-setime").html(h).removeClass("hidden").find("option:[value="+(g.month+1)+"]").attr("selected","selected");this.blur();e.find("input").bind("keydown",function(m){var n=a(m.target);if(m.keyCode==a.om.keyCode.UP){n.val(Number(n.val())+1);n[0].select()}if(m.keyCode==a.om.keyCode.DOWN){n.val(Number(n.val())-1);n[0].select()}if(m.keyCode==a.om.keyCode.ENTER){var l=e.find(".om-setime select").val();var k=e.find(".om-setime input").val();e.find(".om-setime").addClass("hidden");if(!g.Verify().isYear(k)){return}if(!g.Verify().isMonth(l)){return}g.father._render({date:g._computeDate(g,k,l)})}});return false}).bind("mouseover",function(h){a(this).addClass("om-state-hover")}).bind("mouseout",function(h){a(this).removeClass("om-state-hover")});g.EV[4]=e.find(".om-setime").bind("click",function(k){k.preventDefault();var l=a(k.target),j=a(this);if(l.hasClass("ok")){var i=j.find("select").val(),h=j.find("input").val();j.addClass("hidden");if(!g.Verify().isYear(h)){return}if(!g.Verify().isMonth(i)){return}i=i-j.parent().prevAll(".om-cal-box").length-1;g.father._render({date:g._computeDate(g,h,i)})}else{if(l.hasClass("cancel")){j.addClass("hidden")}}})};this._computeDate=function(h,f,g){var e=new Date(h.father.options.date.getTime());e.setFullYear(f,g);return e};this._getNode=function(){var e=this;return e.node};this._getNumOfDays=function(e,f){return 32-new Date(e,f-1,32).getDate()};this.createDS=function(){var n=this,m=n.father.options,h="",l=(new Date(n.year+"/"+(n.month+1)+"/01").getDay()+m.startDay+7)%7,f=n._getNumOfDays(n.year,n.month+1)+l,g;var e=[];for(g=0;g<m.disabledDays.length;g++){e[g]=m.disabledDays[g]%7}for(g=0;g<f;g++){var j=new Date(n.year+"/"+Number(n.month+1)+"/"+(g+1-l).toString());if(g<l){h+='<a href="javascript:void(0);" class="om-null" >0</a>'}else{if(a.inArray((g+m.startDay)%7,e)>=0){h+='<a href="javascript:void(0);" class="om-state-disabled">'+(g-l+1)+"</a>"}else{if(m.disabledFn(j)===false){h+='<a href="javascript:void(0);" class="om-state-disabled">'+(g-l+1)+"</a>"}else{if(m.minDate instanceof Date&&new Date(n.year+"/"+(n.month+1)+"/"+(g+1-l)).getTime()<(m.minDate.getTime()+1)){h+='<a href="javascript:void(0);" class="om-state-disabled">'+(g-l+1)+"</a>"}else{if(m.maxDate instanceof Date&&new Date(n.year+"/"+(n.month+1)+"/"+(g+1-l)).getTime()>m.maxDate.getTime()){h+='<a href="javascript:void(0);" class="om-state-disabled">'+(g-l+1)+"</a>"}else{if(g==(l+(new Date()).getDate()-1)&&(new Date()).getFullYear()==n.year&&(new Date()).getMonth()==n.month){h+='<a href="javascript:void(0);" class="om-state-highlight om-state-nobd">'+(g-l+1)+"</a>"}else{if(g==(l+m.date.getDate()-1)&&n.month==m.date.getMonth()&&n.year==m.date.getFullYear()){h+='<a href="javascript:void(0);" class="om-state-active om-state-nobd">'+(g-l+1)+"</a>"}else{h+='<a href="javascript:void(0);">'+(g-l+1)+"</a>"}}}}}}}}if(f%7!==0){for(g=0;g<(7-f%7);g++){h+='<a href="javascript:void(0);" class="om-null">0</a>'}}n.ds=h};this._render=function(){var e=this;e._renderUI();e._buildEvent()}}});a.extend(a.om.omCalendar,{TimeSelector:function(d,b){var c=a.om.lang.omCalendar;this.father=b;this.fcon=d.parent(".om-cal-box");this.popupannel=this.fcon.find(".om-selectime");if(typeof b.options.date=="undefined"){b.options.date=new Date()}this.time=b.options.date;this.status="s";this.ctime=a('<div class="om-cal-time om-state-default">'+c.time+'：<span class="h">h</span>:<span class="m">m</span>:<span class="s">s</span><!--{{arrow--><div class="cta"><button class="u om-icon om-icon-triangle-1-n"></button><button class="d om-icon om-icon-triangle-1-s"></button></div><!--arrow}}--></div>');this.button=a('<button class="ct-ok om-state-default">'+c.ok+"</button>");this.h_a=["00","01","02","03","04","05","06","07","08","09","10","11","12","13","14","15","16","17","18","19","20","21","22","23"];this.m_a=["00","10","20","30","40","50"];this.s_a=["00","10","20","30","40","50"];this.parseSubHtml=function(e){var g="";for(var f=0;f<e.length;f++){g+='<a href="javascript:void(0);" class="om-cal-item">'+e[f]+"</a>"}g+='<a href="javascript:void(0);" class="x">x</a>';return g};this.showPopup=function(f){var g=this;g.popupannel.html(f);g.popupannel.removeClass("hidden");var e=g.status;var h="om-state-active om-state-nobd";g.ctime.find("span").removeClass(h);switch(e){case"h":g.ctime.find(".h").addClass(h);break;case"m":g.ctime.find(".m").addClass(h);break;case"s":g.ctime.find(".s").addClass(h);break}};this.hidePopup=function(){this.popupannel.addClass("hidden")};this._render=function(){var f=this;var i=f.get("h");var e=f.get("m");var g=f.get("s");f.father._time=f.time;f.ctime.find(".h").html(i);f.ctime.find(".m").html(e);f.ctime.find(".s").html(g);return f};this.set=function(e,g){var f=this;g=Number(g);switch(e){case"h":f.time.setHours(g);break;case"m":f.time.setMinutes(g);break;case"s":f.time.setSeconds(g);break}f._render()};this.get=function(e){var f=this.time;switch(e){case"h":return f.getHours();case"m":return f.getMinutes();case"s":return f.getSeconds()}};this.add=function(){var g=this;var e=g.status;var f=g.get(e);f++;g.set(e,f)};this.minus=function(){var g=this;var e=g.status;var f=g.get(e);f--;g.set(e,f)};this._timeInit=function(){var e=this;d.html("").append(e.ctime);d.append(e.button);e._render();e.popupannel.bind("click",function(h){var g=a(h.target);if(g.hasClass("x")){e.hidePopup()}else{if(g.hasClass("om-cal-item")){var f=Number(g.html());e.set(e.status,f);e.hidePopup()}}});e.button.bind("click",function(g){var i=e.father.options;var h=typeof e.father.dt_date=="undefined"?i.date:e.father.dt_date;h.setHours(e.get("h"));h.setMinutes(e.get("m"));h.setSeconds(e.get("s"));e.father._trigger("onSelect",g,h);if(i.popup){var f=a.omCalendar.formatDate(h,i.dateFormat||e.father._defaultFormat);a(e.father.element).val(f);e.father.hide()}});e.ctime.bind("keyup",function(f){if(f.keyCode==a.om.keyCode.UP||f.keyCode==a.om.keyCode.LEFT){f.preventDefault();e.add()}if(f.keyCode==a.om.keyCode.DOWN||f.keyCode==a.om.keyCode.RIGHT){f.preventDefault();e.minus()}});e.ctime.find(".u").bind("click",function(){e.hidePopup();e.add()});e.ctime.find(".d").bind("click",function(){e.hidePopup();e.minus()});e.ctime.find(".h").bind("click",function(){var f=e.parseSubHtml(e.h_a);e.status="h";e.showPopup(f)});e.ctime.find(".m").bind("click",function(){var f=e.parseSubHtml(e.m_a);e.status="m";e.showPopup(f)});e.ctime.find(".s").bind("click",function(){var f=e.parseSubHtml(e.s_a);e.status="s";e.showPopup(f)})};this._timeInit()}});a.omCalendar=a.omCalendar||{};a.extend(a.omCalendar,{leftPad:function(e,c,d){var b=new String(e);if(!d){d=" "}while(b.length<c){b=d+b}return b.toString()}});a.extend(a.omCalendar,{getShortDayName:function(b){return a.omCalendar.dayMaps[b][0]},getDayName:function(b){return a.omCalendar.dayMaps[b][1]},getShortMonthName:function(b){return a.omCalendar.monthMaps[b][0]},getMonthName:function(b){return a.omCalendar.monthMaps[b][1]},dayMaps:[["Sun","Sunday"],["Mon","Monday"],["Tue","Tuesday"],["Wed","Wednesday"],["Thu","Thursday"],["Fri","Friday"],["Sat","Saturday"]],monthMaps:[["Jan","January"],["Feb","February"],["Mar","March"],["Apr","April"],["May","May"],["Jun","June"],["Jul","July"],["Aug","August"],["Sep","September"],["Oct","October"],["Nov","November"],["Dec","December"]],formatCodes:{d:{g:"this.getDate()",s:"this.setDate({param})",r:"(0[1-9]|[1-2][0-9]|3[0-1]|[1-9])"},dd:{g:"$.omCalendar.leftPad(this.getDate(), 2, '0')",s:"this.setDate(parseInt('{param}', 10))",r:"(0[1-9]|[1-2][0-9]|3[0-1]|[1-9])"},m:{g:"(this.getMonth() + 1)",s:"this.setMonth(parseInt('{param}', 10) - 1)",r:"(0[1-9]|1[0-2]|[1-9])"},mm:{g:"$.omCalendar.leftPad(this.getMonth() + 1, 2, '0')",s:"this.setMonth(parseInt('{param}', 10) - 1)",r:"(0[1-9]|1[0-2]|[1-9])"},y:{g:"('' + this.getFullYear()).substring(2, 4)",s:"this.setFullYear(parseInt('20{param}', 10))",r:"(\\d{2})"},yy:{g:"this.getFullYear()",s:"this.setFullYear(parseInt('{param}', 10))",r:"(\\d{4})"},h:{g:"$.omCalendar.leftPad((this.getHours() % 12) ? this.getHours() % 12 : 12, 2, '0')",s:"this.setHours(parseInt('{param}', 10))",r:"(0[0-9]|1[0-1])"},H:{g:"$.omCalendar.leftPad(this.getHours(), 2, '0')",s:"this.setHours(parseInt('{param}', 10))",r:"([0-1][0-9]|2[0-3])"},g:{g:"((this.getHours() % 12) ? this.getHours() % 12 : 12)",s:"this.setHours(parseInt('{param}', 10))",r:"([0-9]|1[0-1])"},G:{g:"this.getHours()",s:"this.setHours(parseInt('{param}', 10))",r:"([0-9]|1[0-9]|2[0-3])"},i:{g:"$.omCalendar.leftPad(this.getMinutes(), 2, '0')",s:"this.setMinutes(parseInt('{param}', 10))",r:"([0-5][0-9])"},s:{g:"$.omCalendar.leftPad(this.getSeconds(), 2, '0')",s:"this.setSeconds(parseInt('{param}', 10))",r:"([0-5][0-9])"},u:{g:"$.omCalendar.leftPad(this.getMilliseconds(), 3, '0')",s:"this.setMilliseconds(parseInt('{param}', 10))",r:"(\\d{1,3})"},D:{g:"$.omCalendar.getShortDayName(this.getDay())",s:"",r:""},DD:{g:"$.omCalendar.getDayName(this.getDay())",s:"",r:""},M:{g:"$.omCalendar.getShortMonthName(this.getMonth())",s:"",r:""},MM:{g:"$.omCalendar.getMonthName(this.getMonth())",s:"",r:""},a:{g:"(this.getHours() < 12 ? 'am' : 'pm')",s:"",r:""},A:{g:"(this.getHours() < 12 ? 'AM' : 'PM')",s:"",r:""}}});a.extend(a.omCalendar,{formatDate:function(c,e){if(!c||!e){return null}if(!(Object.prototype.toString.call(c)==="[object Date]")){return null}var d,g,b="",f=false;for(d=0;d<e.length;d++){g=e.charAt(d);fi_next=e.charAt(d+1);if(g=="'"){f=!f;continue}if(!f&&a.omCalendar.formatCodes[g+fi_next]){g=new Function("return "+a.omCalendar.formatCodes[g+fi_next].g).call(c);d++}else{if(!f&&a.omCalendar.formatCodes[g]){g=new Function("return "+a.omCalendar.formatCodes[g].g).call(c)}}b+=g}return b},parseDate:function(g,j){if(!g||!j){return null}if(!(Object.prototype.toString.call(g)==="[object String]")){return null}var c=[],e,k,h=null,b;for(e=0;e<j.length;e++){k=j.charAt(e);fi_next=j.charAt(e+1);if(a.omCalendar.formatCodes[k+fi_next]){h=a.omCalendar.formatCodes[k+fi_next];e++}else{if(a.omCalendar.formatCodes[k]){h=a.omCalendar.formatCodes[k]}else{continue}}b=g.match(new RegExp(h.r));if(!b){return null}c.push(h.s.replace("{param}",b[0]));g=g.substring(b.index+b[0].length);var f=j.charAt(e+1);if(!(f==""&&g=="")&&(f!==g.charAt(0))&&(a.omCalendar.formatCodes[f]===undefined)){return null}}var d=new Date();new Function(c.join(";")).call(d);return d}});a.om.lang.omCalendar={year:"年",month:"月",Su:"日",Mo:"一",Tu:"二",We:"三",Th:"四",Fr:"五",Sa:"六",cancel:"取消",ok:"确定",time:"时间"}})(jQuery);