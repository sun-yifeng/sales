(function(d){var l=Object.prototype.hasOwnProperty;d.omWidget.addInitListener("om.omGrid",function(){var B=this,A=B.element,D=B.options,y=this._getColModel();B._triggered=false;B._globalEditable=false;D.editMode=D.editMode||"all";B._allEditMode=D.editMode=="all";for(var C=0,x=y.length;C<x;C++){B._globalEditable=y[C]["editor"]?true:false;if(B._globalEditable){break}}if(!i(B)){return}B._editComps={};B._errorHolders={};B._colWidthResize;D._onRefreshCallbacks.push(u);D._onResizableStopCallbacks.push(k);D._onResizeCallbacks.push(j);this.tbody.delegate("tr.om-grid-row","dblclick",function(E){b.call(this,B)});this.tbody.delegate("tr.om-grid-row","click",function(E){if(B._triggered&&B._editView.editing){if(B._validator){B._validator.valid()&&b.call(this,B)}else{b.call(this,B)}}});var z=null;A.parent().scroll(function(){if(B._triggered){if(z){clearTimeout(z)}z=setTimeout(function(){var E=w(B);B._editView.editBtn.animate({left:E.left,top:E.top},B._editView.editing?"fast":0);z=null},300)}});d.extend(this,{cancelEdit:function(G){var F=this._editView,E=this.options;if(!i(this)||!this._triggered||(this._triggered&&!F.editing)){return}F.view.hide();F.editing=false;if(this._rowAdding){this.deleteRow(this._getTrs().index(this.tbody.find("tr[_grid_row_id='"+B._editView.rowId+"']")));this._rowAdding=false}t(this);G&&d(G).blur();E.onCancelEdit&&E.onCancelEdit.call(this)},cancelChanges:function(){this.cancelEdit();if(f(this)){return}g(this);t(this);this.refresh()},editRow:function(E){if(!i(this)){return}b.call(this._getTrs().eq(E)[0],this)},deleteRow:function(G){if(!i(this)||(this._triggered&&this._editView.editing)){return}var F=this._getTrs(),E=this;if(!d.isArray(G)){G=[G]}G.sort(function(I,H){return H-I});d(G).each(function(I,K){var J=F.eq(K),H=J.next(),L=a(J);if(J.attr("_insert")){delete E._changeData.insert[L];J.remove();if(H.hasClass("rowExpand-rowDetails")){H.remove()}}else{E._changeData["delete"][L]=E._rowIdDataMap[L];J.attr("_delete","true").hide();if(H.hasClass("rowExpand-rowDetails")){H.hide()}}});this._refreshHeaderCheckBox()},getChanges:function(I){var K={update:[],insert:[],"delete":[]},E=I?I:"update",H=this._changeData;if(E==="update"){var F=H[E];for(var G in F){l.call(F,G)&&K[E].push(d.extend(true,{},this._rowIdDataMap[G],F[G]))}E=I?I:"insert"}if(E==="insert"){var J=H[E];for(var G in J){l.call(J,G)&&K[E].push(J[G])}E=I?I:"delete"}if(E==="delete"){var L=H[E];for(var G in L){l.call(L,G)&&K[E].push(L[G])}}if(I){return K[I]}else{return K}},insertRow:function(P,J,S){var G=this.options,Q=this._getColModel(),F=this.element;if(!i(this)||this._rowAdding){return}if(d.isPlainObject(P)){J=P;P=0}if(P===true){J={};P=0;S=true}var H=this._getTrs(),T={};P=("begin"==P||P==undefined)?0:("end"==P?H.length:P);for(var L=0,O=Q.length;L<O;L++){T[Q[L]["name"]]=""}this._changeData.insert[this._guid]=d.extend(true,T,J);var R=this._buildRowCellValues(Q,T,P),E=[],I=G.rowClasses;isRowClassesFn=(typeof I==="function"),rowCls=isRowClassesFn?I(P,T):I[P%I.length],tdTmp="<td align='$' abbr='$' class='grid-cell-dirty $'><div align='$' class='$' style='width:$px'>$</div></td>";E.push("<tr class='om-grid-row "+rowCls+"' _grid_row_id="+(this._guid++)+" _insert='true'>");this._getHeaderCols().each(function(X){var Z=d(this).attr("axis"),Y=false,W,aa,V;if(Z=="indexCol"){W="<a class='om-icon'>新行</a>"}else{if(Z=="checkboxCol"){W='<span class="checkbox"/>'}else{if(Z.substring(0,3)=="col"){var U=Z.substring(3);W=R[U];if(Q[U].wrap){Y=true}}else{W=""}}}aa=[this.align,this.abbr,Z,this.align,Y?"wrap":"",d("div",d(this)).width(),W];V=0;E.push(tdTmp.replace(/\$/g,function(){return aa[V++]}))});E.push("</tr>");var N=d(E.join(" ")),M,K;if(P==0){N.prependTo(F.find(">tbody"))}else{M=H.eq(P-1);K=M.next();M=K.hasClass("rowExpand-rowDetails")?K:M;M.after(N)}if(!S){this.editRow(P);this._rowAdding=true}},saveChanges:function(){this.cancelEdit();if(f(this)){return}var G=this._changeData.update,F=this.element.find("tr.om-grid-row"),I=[];for(var H in G){if(l.call(G,H)){d.extend(true,this._rowIdDataMap[H],G[H])}}var E=this;F.each(function(J,L){var K=d(L);if(K.attr("_delete")){K.remove()}else{I.push(v(E,L))}});this.pageData.data.rows=I;g(this);t(this);this.refresh()},onBeforeEdit:function(F,E){},onAfterEdit:function(F,E){},onCancelEdit:function(){},getData:function(){var E=this.pageData.data,G=this._getTrs(),F=this;if(i(this)&&h(this)){E={total:E.total};E.rows=[];G.each(function(H,I){E.rows.push(F._getRowData(H))})}return E},_getRowData:function(F){var H=this._getTrs().eq(F),J=a(H),I;if(f(this)){return this.pageData.data.rows[F]}if(H.attr("_insert")){I=this._changeData.insert[J]}else{var G=this._rowIdDataMap[J],E=this._changeData.update;I=G;if(E[J]){I=d.extend(true,{},G,E[J])}}return I}})});function b(I){var D=d(this),y=I.element,E,C,B,H=I._getColModel(),x,G,z=I.options;if(!i(I)){return}if(!I._allEditMode&&!D.attr("_insert")){return}if(I._triggered&&I._editView.editing&&a(D)==I._editView.rowId){return}if(I._rowAdding){return}var F=I._getTrs().index(D),A=I._getRowData(F);if(z.onBeforeEdit&&z.onBeforeEdit.call(I,F,A)===false){return}r(I,D);E=I._editView.editRow;C=E.find(">.grid-edit-form");B=y.parent().scrollLeft();I._getHeaderCols().each(function(Q){var L=d(this).attr("axis"),N,T=D.find("td:eq("+Q+")"),V;if(L.substring(0,3)=="col"){var U=L.substring(3);N=H[U]}else{if(d.isEmptyObject(I._editComps)){E.css("padding-left",parseInt(E.css("padding-left"))+T.outerWidth())}return}var P=N.editor;if(!I._triggered){if(!P||(P&&(P.editable===false||(d.isFunction(P.editable)&&P.editable()===false)))){var R=P&&P.renderer;N.editor=P={};P.type="text";if(R){P.renderer=R;P.type="custom"}P.editable=false}else{P.type=P.type||"text";P.editable=true;if(P.rules){I._validate=true}}V=N.editor.name||N.name;P.options=P.options||{};I._editComps[V]={}}else{V=N.editor.name||N.name}x=I._editComps[V];G=(G=n(I,D,N))==undefined?"":G;if(!I._triggered&&P.editable&&P.rules){I._errorHolders[V]=d("<div class='errorContainer' style='display:none'></div>").appendTo(y.parent())}var K=x.instance,O,S=P.type;if(!K){O=d("<div style='position:absolute'></div>").css({left:T.position().left+B,top:3}).appendTo(C).addClass("grid-edit-wrapper");K=x.instance=d("<input></input>").attr({name:V,id:V}).appendTo(O);if("text"!=S&&"custom"!=S){K[S](P.options)}if("omCalendar"==S||"omCombo"==S){var M=K.parent();if("omCalendar"==S){K.val(G).width(T.outerWidth()-24);K.width(T.outerWidth(true)-(M.outerWidth(true)-K.width()))}else{K.next("input").attr({id:K.prop("id"),name:K.prop("name")});K.attr({id:"",name:""});K.next("input").width(T.outerWidth(true)-(M.outerWidth(true)-K.next("input").width()))}}else{if("text"==S){K.addClass("grid-edit-text");if(!P.editable){K.attr("readonly","readonly").addClass("readonly-text")}}if("custom"==S){K=x.instance=O.html(P.renderer.call(I,G,A))}K.width(T.outerWidth(true)-(K.outerWidth(true)-K.width()))}x.model=N;x.type=S;x.id=N.name;if("custom"!=S){var J="omCombo"==S?K.next():K;J.blur(function(X){var W=I._errorHolders[V];W&&W.hide()})}}switch(S){case"omCalendar":K=K.val(G).omCalendar();break;case"omNumberField":K.val(G).trigger("blur");break;case"omCombo":K.omCombo("value",G);break;case"text":K.val(G);break;case"custom":K.html(P.renderer.call(I,G,A));default:}});!I._triggered&&I._validate&&q(I);I._validator&&I._validator.form();I._triggered=true}function g(x){x._changeData={update:{},insert:{},"delete":{}}}function f(x){return !i(x)||!h(x)}function w(y){var x=y.element,A=x.parent(),B=y._editView,z=B.editBtn,D=B.editRow,C={};C.top=D.height();if(x.width()<A.width()){C.left=x.width()/2-z.width()/2}else{C.left=A.scrollLeft()+A.width()/2-z.width()/2}return C}function u(){if(i(this)){g(this);s(this);if(this._triggered){t(this);this._editView.view.hide();this._editView.editing=false;this.hDiv.scrollLeft(0);this.element.parent().scrollLeft(0)}}}function i(x){return !x._allEditMode||x._globalEditable}function s(y){var x=y.getData().rows;y._rowIdDataMap={};y._getTrs().each(function(z,A){y._rowIdDataMap[a(A)]=x[z]})}function t(x){if(x._validator){x._validator.resetForm();d.each(x._errorHolders,function(y,z){z.empty().hide()})}}function h(y){var x=y._changeData;return !(d.isEmptyObject(x.update)&&d.isEmptyObject(x.insert)&&d.isEmptyObject(x["delete"]))}function r(I,E){var x=I.element,H=x.next(".grid-edit-view"),B=d(E).position(),y=x.parent().scrollTop(),z=I.options;if(H.length==0){H=d("<div class='grid-edit-view'><div class='body-wrapper'><div class='grid-edit-row'><form class='grid-edit-form'></form></div><div class='gird-edit-btn'><input type='button' class='ok' value='确定'/><input type='button' class='cancel' value='取消'/></div></div></div>").width(x.outerWidth()).insertAfter(x);var G=H.find(".gird-edit-btn"),D=G.prev(".grid-edit-row"),F;I._editView={view:H,editRow:D,editBtn:G};F=w(I);G.css({left:F.left,top:F.top});var C=G.find("input.ok").omButton(),A=G.find("input.cancel").omButton();C.click(function(){if(I._validator&&!I._validator.form()){return}var J=x.find("tr[_grid_row_id='"+I._editView.rowId+"']");c(I,J);H.hide();I._editView.editing=false;C.blur();if(I._rowAdding){I._refreshHeaderCheckBox();I._rowAdding=false}var K=I._getTrs().index(J);z.onAfterEdit&&z.onAfterEdit.call(I,K,I._getRowData(K))});A.click(function(){I.cancelEdit(this)})}I._editView.rowId=a(E);if(I._editView.editing){H.animate({top:B.top+y},"fast")}else{H.css({top:B.top+y});I._editView.editing=true;H.show();if(I._colWidthResize){p(I);I._colWidthResize=false}}}function j(){if(!i(this)||!this._triggered){return}if(this._editView.editing){this.element.parent().scrollLeft(0);var x=this;setTimeout(function(){p(x)},0)}else{this._colWidthResize=true}}function p(G,D,z){var x=G.element,C=G._editView,F=C.view,y=x.parent().scrollLeft(),E=C.editBtn,A=false;F.width(x.outerWidth());G._getHeaderCols().each(function(H,J){var L=d(J).attr("abbr"),I=d(J),K=D&&D.prop("abbr")===I.prop("abbr");if(K){A=true}if(D&&!A){return}d.each(G._editComps,function(N,M){var P=M.instance,O=M.type;if(L==M.id){if(!K&&D){P.closest("div.grid-edit-wrapper").css("left","+="+z);return false}if(!K){P.closest("div.grid-edit-wrapper").width(I.outerWidth()).css("left",I.position().left+y)}if("omCalendar"==O||"omCombo"==O){var Q=P.parent();if("omCalendar"==O){P.width(I.outerWidth()-24);P.width(I.outerWidth(true)-(Q.outerWidth(true)-P.width()))}else{P.next("input").width(I.outerWidth(true)-(Q.outerWidth(true)-P.next("input").width()))}}else{P.width(I.outerWidth(true)-(P.outerWidth(true)-P.width()))}}})});var B=w(G);if(D){E.animate({left:B.left,top:B.top},"fast")}else{E.css({left:B.left,top:B.top})}}function k(x,y){if(!i(this)||!this._triggered||!this._editView.editing){this._colWidthResize=true;return}p(this,x,y)}function c(x,B){var z=d(B),D=x._editComps,C=a(z),y=x._getTrs().index(z),A=x._getRowData(y);d.each(D,function(G,F){var I=F.model.name,K=e(x,z,F),E,H,J;if(z.attr("_insert")){x._changeData.insert[C][I]=K}else{E=v(x,B)[I];J=x._changeData.update[C];if(String(K)===String(E)){m(z,F.model,false);J&&delete J[I];d.isEmptyObject(J)&&delete x._changeData.update[C]}else{m(z,F.model,true);J=x._changeData.update[C]=J||{};J[I]=K}}if(F.model.renderer){H=F.model.renderer(K,A,y)}else{H=K==undefined?"":K}z.find("td[abbr='"+I+"'] >div")[0].innerHTML=H})}function m(z,y,x){z.find("td[abbr='"+y.name+"']").toggleClass("grid-cell-dirty",x)}function a(x){return d(x).attr("_grid_row_id")}function e(y,A,x){var C,B=v(y,A),z=x.instance;switch(x.type){case"omCalendar":C=z.val();case"omNumberField":C=z.val();break;case"omCombo":C=z.omCombo("value");break;case"text":C=z.val();break;case"custom":if(x.model.editor.getValue){return x.model.editor.getValue.call(z,B,x.model.name)}default:break}return C}function n(x,B,A){var C,z=A.name;if(B.attr("_insert")){C=v(x,B)[z]}else{var y=x._changeData.update[a(B)];if(y&&y[z]!=null){C=y[z]}else{C=v(x,B)[z]}}return C}function v(x,y){var z=a(y);return d(y).attr("_insert")?x._changeData.insert[z]:x._rowIdDataMap[z]}function q(y){var x=y._editView.editRow.find(">.grid-edit-form"),B={},C=B.rules={},A=B.messages={},z=y._getColModel();d.each(z,function(J,H){var I=H.editor.rules;if(I){var D=C[H.editor.name||H.name]={},F=A[H.editor.name||H.name]={};if(I.length>0&&!d.isArray(I[0])){var L=[];L.push(I);I=L}for(var G=0,K=I.length;G<K;G++){var E=I[G][0];D[E]=I[G][1]==undefined?true:I[G][1];if(I[G][2]){F[E]=I[G][2]}}}});d.extend(B,{onkeyup:function(D){this.element(D)},errorPlacement:function(D,E){},showErrors:function(F,G){if(G&&G.length>0){d.each(G,function(J,L){var H=d(L.element),I=H.attr("name");var K=y._errorHolders[I];if(K){if(H.is(":focus")){K.show()}K.html(L.message);o(y,H,K)}})}else{d.each(this.currentElements,function(H,I){var J=y._errorHolders[d(I).attr("name")];J&&J.empty().hide()})}var D=y._editView.editBtn.find("input.ok"),E=true;d.each(y._errorHolders,function(H,I){if(!I.is(":empty")){return E=false}});E?D.omButton("enable"):D.omButton("disable");this.defaultShowErrors()}});y._validator=x.validate(B);d.each(y._editComps,function(F,E){var H=E.model.editor;if(H.editable&&H.rules){var G=H.name||E.model.name,I=y._errorHolders[G],D=E.type=="omCombo"?E.instance.next("input"):E.instance;D.mouseover(function(){if(I&&!I.is(":empty")){var J=d(this);I.show();o(y,J,I)}}).mouseout(function(){I&&I.hide()})}})}function o(A,C,D){var z=C.offset(),x=A.element.offset(),B=A.element.parent(),y=C.closest(".grid-edit-wrapper"),E=z.top-x.top+y.outerHeight();if(z.left-x.left-B.scrollLeft()+y.outerWidth()+D.outerWidth()>B.width()){D.css({left:z.left-x.left-D.outerWidth(),top:E})}else{D.css({left:z.left-x.left+y.outerWidth(),top:E})}}})(jQuery);